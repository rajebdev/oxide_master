name: Build and Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]

jobs:
  build:
    name: Build & Package DMG (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve Swift packages
        run: swift package resolve

      - name: Build (release)
        run: swift build -c release

      - name: Prepare .app bundle (from dev.sh)
        run: |
          set -e
          echo "ðŸ“¦ Creating/updating OxideMaster.app bundle"
          rm -rf OxideMaster.app || true
          mkdir -p OxideMaster.app/Contents/MacOS OxideMaster.app/Contents/Resources
          cp .build/release/OxideMaster OxideMaster.app/Contents/MacOS/
          if [ -f "OxideMaster/Info.plist" ]; then
            cp OxideMaster/Info.plist OxideMaster.app/Contents/
          fi

          # Create app icon if helper exists
          if [ -f "create_icns.sh" ]; then
            bash create_icns.sh || true
          fi

          # Remove quarantine attributes
          xattr -cr OxideMaster.app || true

          # Codesign with runtime option if possible, otherwise sign without runtime
          codesign --force --deep --sign - --options runtime OxideMaster.app 2>/dev/null || \
          codesign --force --deep --sign - OxideMaster.app 2>/dev/null || true

      - name: Create DMG (from dev.sh)
        id: create_dmg
        run: |
          set -e
          APP_NAME="OxideMaster"
          # Try to read version from Info.plist
          VERSION="1.0.0"
          if [ -f "OxideMaster.app/Contents/Info.plist" ]; then
            VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" OxideMaster.app/Contents/Info.plist 2>/dev/null || true)
            VERSION=${VERSION:-1.0.0}
          fi

          # If running on a tag, prefer the tag name (strip leading v)
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            REF_NAME="${GITHUB_REF##*/}"
            VERSION="${REF_NAME#v}"
          fi

          DMG_NAME="${APP_NAME}-${VERSION}.dmg"
          DMG_TEMP="dmg_temp"

          echo "ðŸ’¿ Creating DMG: $DMG_NAME"
          rm -rf "$DMG_TEMP" "$DMG_NAME"
          mkdir -p "$DMG_TEMP"
          cp -R OxideMaster.app "$DMG_TEMP/"

          # Clean quarantine attributes and sign inside temp
          xattr -cr "$DMG_TEMP/OxideMaster.app" || true
          codesign --force --deep --sign - "$DMG_TEMP/OxideMaster.app" 2>/dev/null || true

          # Create symlink to /Applications
          ln -s /Applications "$DMG_TEMP/Applications"

          # Create compressed DMG
          hdiutil create -volname "$APP_NAME" \
                         -srcfolder "$DMG_TEMP" \
                         -ov -format UDZO \
                         "$DMG_NAME"

          rm -rf "$DMG_TEMP"
          xattr -cr "$DMG_NAME" 2>/dev/null || true

          if [ ! -f "$DMG_NAME" ]; then
            echo "Failed to create DMG"
            exit 1
          fi

          echo "dmg=$DMG_NAME" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: Built from ${{ github.sha }}

      - name: Upload DMG to created release (tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.create_dmg.outputs.dmg }}
          asset_name: ${{ steps.create_dmg.outputs.dmg }}
          asset_content_type: application/x-apple-diskimage

      - name: Upload DMG to existing release (release event)
        if: ${{ github.event_name == 'release' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ steps.create_dmg.outputs.dmg }}
          asset_name: ${{ steps.create_dmg.outputs.dmg }}
          asset_content_type: application/x-apple-diskimage

      - name: Upload artifact (fallback)
        if: ${{ github.event_name != 'release' && !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v4
        with:
          name: oxide-dmg
          path: ${{ steps.create_dmg.outputs.dmg }}
